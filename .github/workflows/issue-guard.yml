name: issue-guard

on:
  issues:
    types: [opened]

permissions:
  issues: write
  contents: read

jobs:
  issue-guard:
    runs-on: ubuntu-latest
    steps:
      - name: Validate issue template sections
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || "";

            const requiredHeadings = [
              "## ğŸ¯ ç›®çš„ï¼ˆWhyï¼‰",
              "## ğŸ“Œ ä»•æ§˜ï¼ˆWhatï¼‰",
              "## âœ… å—ã‘å…¥ã‚Œæ¡ä»¶ï¼ˆAcceptance Criteriaï¼‰",
              "## ğŸ§ª ãƒ†ã‚¹ãƒˆè¦³ç‚¹",
              "## âš™ éæ©Ÿèƒ½è¦ä»¶",
              "## ğŸ”„ å½±éŸ¿ç¯„å›²",
              "## â›“ åˆ¶ç´„ãƒ»å‰æ",
              "## â“ æœªç¢ºå®šãƒ»è¦ç¢ºèªäº‹é …",
            ];

            const missing = requiredHeadings.filter((h) => !body.includes(h));

            if (missing.length === 0) {
              core.info("issue-guard: required headings are complete");
              return;
            }

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = issue.number;
            const labels = (issue.labels || []).map((l) => l.name);
            const hasAiQuestion = labels.includes("ai-question");

            // Add ai-question label when template is incomplete (avoid duplicate add)
            if (!hasAiQuestion) {
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number,
                labels: ["ai-question"],
              });
            }

            const list = missing.map((h) => `- ${h}`).join("\n");
            const foundCount = requiredHeadings.length - missing.length;
            const message = [
              "issue-guard: Issueãƒ†ãƒ³ãƒ—ãƒ¬ã®å¿…é ˆè¦‹å‡ºã—ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚",
              "",
              `- æ¤œå‡ºã§ããŸè¦‹å‡ºã—: ${foundCount}/${requiredHeadings.length}`,
              `- ä¸è¶³è¦‹å‡ºã—æ•°: ${missing.length}`,
              "",
              "ä¸è¶³ã—ã¦ã„ã‚‹è¦‹å‡ºã—:",
              list,
              "",
              "æ¬¡ã®å¯¾å¿œ:",
              "1. ä¸Šè¨˜è¦‹å‡ºã—ã‚’Issueæœ¬æ–‡ã«è¿½è¨˜",
              "2. å¿…è¦äº‹é …ã‚’è¨˜å…¥ã—ã¦ä¿å­˜",
              "3. `ai-ready` ã‚’ä»˜ä¸ã—ã¦AIç€æ‰‹å¯èƒ½çŠ¶æ…‹ã«ã™ã‚‹",
              "",
              "è£œå®Œå¾Œã« `ai-ready` ã‚’ä»˜ä¸ã—ã¦AIç€æ‰‹å¯èƒ½çŠ¶æ…‹ã«ã—ã¦ãã ã•ã„ã€‚",
            ].join("\n");

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number,
              body: message,
            });

            core.setFailed(`Missing required headings: ${missing.join(", ")}`);
