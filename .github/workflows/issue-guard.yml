name: issue-guard

on:
  issues:
    types: [opened, edited]

permissions:
  issues: write
  contents: read

jobs:
  issue-guard:
    runs-on: ubuntu-latest
    env:
      WEBHOOK_URL: ${{ secrets.AI_NOTIFY_WEBHOOK_URL }}
    steps:
      - name: Validate issue template sections
        id: guard
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || "";
            core.setOutput("notify", "false");

            const requiredHeadings = [
              "## ğŸ¯ ç›®çš„ï¼ˆWhyï¼‰",
              "## ğŸ“Œ ä»•æ§˜ï¼ˆWhatï¼‰",
              "## âœ… å—ã‘å…¥ã‚Œæ¡ä»¶ï¼ˆAcceptance Criteriaï¼‰",
              "## ğŸ§ª ãƒ†ã‚¹ãƒˆè¦³ç‚¹",
              "## âš™ éæ©Ÿèƒ½è¦ä»¶",
              "## ğŸ”„ å½±éŸ¿ç¯„å›²",
              "## â›“ åˆ¶ç´„ãƒ»å‰æ",
              "## â“ æœªç¢ºå®šãƒ»è¦ç¢ºèªäº‹é …",
            ];

            const missing = requiredHeadings.filter((h) => !body.includes(h));

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = issue.number;
            const labels = (issue.labels || []).map((l) => l.name);
            const hasAiQuestion = labels.includes("ai-question");

            if (missing.length === 0) {
              if (hasAiQuestion) {
                try {
                  await github.rest.issues.removeLabel({
                    owner,
                    repo,
                    issue_number,
                    name: "ai-question",
                  });
                } catch (_) {
                  // already removed or not present
                }
              }
              core.info("issue-guard: required headings are complete");
              return;
            }

            // Add ai-question label when template is incomplete (avoid duplicate add)
            if (!hasAiQuestion) {
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number,
                labels: ["ai-question"],
              });
            }

            if (!hasAiQuestion) {
              const list = missing.map((h) => `- ${h}`).join("\n");
              const foundCount = requiredHeadings.length - missing.length;
              const message = [
                "issue-guard: Issueãƒ†ãƒ³ãƒ—ãƒ¬ã®å¿…é ˆè¦‹å‡ºã—ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚",
                "",
                `- æ¤œå‡ºã§ããŸè¦‹å‡ºã—: ${foundCount}/${requiredHeadings.length}`,
                `- ä¸è¶³è¦‹å‡ºã—æ•°: ${missing.length}`,
                "",
                "ä¸è¶³ã—ã¦ã„ã‚‹è¦‹å‡ºã—:",
                list,
                "",
                "æ¬¡ã®å¯¾å¿œ:",
                "1. ä¸Šè¨˜è¦‹å‡ºã—ã‚’Issueæœ¬æ–‡ã«è¿½è¨˜",
                "2. å¿…è¦äº‹é …ã‚’è¨˜å…¥ã—ã¦ä¿å­˜",
                "3. `ai-ready` ã‚’ä»˜ä¸ã—ã¦AIç€æ‰‹å¯èƒ½çŠ¶æ…‹ã«ã™ã‚‹",
                "",
                "è£œå®Œå¾Œã« `ai-ready` ã‚’ä»˜ä¸ã—ã¦AIç€æ‰‹å¯èƒ½çŠ¶æ…‹ã«ã—ã¦ãã ã•ã„ã€‚",
              ].join("\n");

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body: message,
              });
            }

            core.setOutput("notify", "true");
            core.setFailed(`Missing required headings: ${missing.join(", ")}`);

      - name: Notify external hook (ai-question)
        if: always() && steps.guard.outputs.notify == 'true' && env.WEBHOOK_URL != ''
        continue-on-error: true
        run: |
          curl -fsS -X POST \
            -H "Content-Type: application/json" \
            -d "{\"event\":\"ai_state_changed\",\"label\":\"ai-question\",\"source\":\"issue-guard\",\"repository\":\"${{ github.repository }}\",\"issue_number\":${{ github.event.issue.number }},\"issue_url\":\"${{ github.event.issue.html_url }}\"}" \
            "$WEBHOOK_URL"
