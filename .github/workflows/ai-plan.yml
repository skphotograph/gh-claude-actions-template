name: ai-plan

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write

concurrency:
  group: run-claude-plan-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  ai-plan:
    if: >-
      github.event.issue.pull_request == null &&
      startsWith(github.event.comment.body, '/run-claude plan')
    runs-on: ubuntu-latest
    steps:
      - name: Validate labels
        id: guard
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;

            const labels = (context.payload.issue.labels || []).map(l => l.name);
            const hasAiReady = labels.includes("ai-ready");
            const blocked = labels.includes("ai-question") || labels.includes("ai-blocked");

            if (!hasAiReady || blocked) {
              const reasons = [];
              if (!hasAiReady) reasons.push("- `ai-ready` ãƒ©ãƒ™ãƒ«ãŒæœªä»˜ä¸ã§ã™");
              if (blocked) reasons.push("- `ai-question` ã¾ãŸã¯ `ai-blocked` ãƒ©ãƒ™ãƒ«ãŒä»˜ä¸ã•ã‚Œã¦ã„ã¾ã™");

              const body = [
                "`/run-claude plan` ã¯ç¾åœ¨å®Ÿè¡Œã§ãã¾ã›ã‚“ã€‚",
                "",
                "ç†ç”±:",
                ...reasons,
                "",
                "å¯¾å¿œå¾Œã«ã‚‚ã†ä¸€åº¦ `/run-claude plan` ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ãã ã•ã„ã€‚",
              ].join("\n");

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body,
              });
              core.setFailed("ai-plan preconditions are not satisfied");
            }

      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Claude plan
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ github.token }}
          max_tokens: 12000
          direct_prompt: |
            Issue #${{ github.event.issue.number }} ã®å†…å®¹ã‚’èª­ã¿ã€å®Ÿè£…è¨ˆç”»ï¼ˆplanï¼‰ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

            ## ã‚ãªãŸã®å½¹å‰²
            read-only åˆ†æè€…ã§ã™ã€‚ã‚³ãƒ¼ãƒ‰ã‚’ä¸€åˆ‡å¤‰æ›´ã›ãšã€ä»¥ä¸‹ã®é †åºã§èª¿æŸ»ãƒ»è¨­è¨ˆã—ã¦ãã ã•ã„ã€‚

            ### Step 1: explorerï¼ˆç¾çŠ¶æŠŠæ¡ï¼‰
            - Issue ã®ã€ŒğŸ“Œ ä»•æ§˜ã€ã€ŒğŸ”„ å½±éŸ¿ç¯„å›²ã€ã€Œâ›“ åˆ¶ç´„ãƒ»å‰æã€ã‚’èª­ã‚€
            - å¤‰æ›´ãŒå¿…è¦ã¨æ€ã‚ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ Glob / Grep / Read ã§ç‰¹å®šã™ã‚‹
            - é–¢é€£ã™ã‚‹æ—¢å­˜ãƒ†ã‚¹ãƒˆã‚’æ¢ã™
            - `policy.yml` ã‚’èª­ã¿ã€`allowed_dirs` / `hard_gate` / `soft_gate` ã‚’ç¢ºèªã™ã‚‹

            ### Step 2: policy-sentinelï¼ˆãƒãƒªã‚·ãƒ¼ç¢ºèªï¼‰
            - å¤‰æ›´å€™è£œãƒ•ã‚¡ã‚¤ãƒ«ãŒ `allowed_dirs` / `allowed_files` ã«åã¾ã‚‹ã‹ç¢ºèªã™ã‚‹
            - `hard_gate` ã«æŠµè§¦ã™ã‚‹ãƒ‘ã‚¹ãŒå«ã¾ã‚Œã¦ã„ãªã„ã‹ç¢ºèªã™ã‚‹ï¼ˆæŠµè§¦ãªã‚‰å³åœæ­¢ï¼‰
            - `soft_gate` æŠµè§¦ãŒã‚ã‚‹å ´åˆã¯å¿…è¦ãªä¾‹å¤–ãƒ©ãƒ™ãƒ«ã‚’æç¤ºã™ã‚‹
            - `limits` ã®ä¸Šé™ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«æ•°ãƒ»diffè¡Œæ•°ï¼‰ã‚’è¶…ãˆãªã„ã‹è¦‹ç©ã‚‚ã‚‹

            ### Step 3: architectï¼ˆè¨­è¨ˆæ¡ˆï¼‰
            - æ–¹é‡A / æ–¹é‡B ã‚’æç¤ºã™ã‚‹ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
            - å¤‰æ›´ç‚¹ãƒªã‚¹ãƒˆï¼ˆãƒ•ã‚¡ã‚¤ãƒ«å˜ä½ï¼‰ã‚’ä½œæˆã™ã‚‹
            - Issue ã®ã€Œâœ… å—ã‘å…¥ã‚Œæ¡ä»¶ã€ã«å¯¾ã™ã‚‹ AC â†’ Test å¯¾å¿œè¡¨ã‚’ä½œæˆã™ã‚‹
            - ãƒªã‚¹ã‚¯ã¨ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ¡ˆã‚’æç¤ºã™ã‚‹

            ## åœæ­¢æ¡ä»¶
            - ä»•æ§˜ä¸è¶³ï¼ˆspec gapï¼‰ã‚’ç™ºè¦‹ã—ãŸã‚‰ **æ¨æ¸¬ã›ãš** è³ªå•ãƒªã‚¹ãƒˆã‚’æç¤ºã—ã¦åœæ­¢ã™ã‚‹
              - ã‚³ãƒ¡ãƒ³ãƒˆæœ«å°¾ã«ã€Œâš ï¸ ai-question ãƒ©ãƒ™ãƒ«ã‚’ä»˜ä¸ã—ã¦å†åº¦ /run-claude plan ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚ã€ã¨ä¿ƒã™
            - Hard Gate ã«æŠµè§¦ã™ã‚‹å¤‰æ›´ãŒå¿…è¦ãªå ´åˆã¯å³åœæ­¢ã™ã‚‹

            ## å‡ºåŠ›å½¢å¼
            ã“ã®Issueï¼ˆ#${{ github.event.issue.number }}ï¼‰ã«ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æŠ•ç¨¿ã™ã‚‹ã€‚
            ã‚³ãƒ¡ãƒ³ãƒˆã®å†’é ­ã« `## ğŸ“‹ Plan: Issue #${{ github.event.issue.number }}` ã¨è¨˜è¼‰ã™ã‚‹ã€‚

            ## Issueæœ¬æ–‡
            ${{ github.event.issue.body }}
          allowed_tools: "Read,Glob,Grep,WebFetch"
