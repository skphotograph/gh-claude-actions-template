name: ai-review

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write

jobs:
  ai-review:
    if: >-
      github.event.issue.pull_request != null &&
      startsWith(github.event.comment.body, '/run-claude review')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Claude review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ github.token }}
          direct_prompt: |
            PR #${{ github.event.issue.number }} のコードレビューを行ってください。

            ## あなたの役割
            reviewer Subagent です。PR の差分を read-only で確認し、品質上の懸念を指摘・質問してください。
            **コードを変更しないでください。マージの可否を断言しないでください。**

            ### 確認事項

            1. **AC → Test 整合**
               - PR 本文の「AC → Test 対応表」を読む
               - 各ACがテストで担保されているか確認する
               - 未カバーの AC を指摘する

            2. **実装の観点チェック**
               - 変更ファイルを Read で読み、以下を確認する
                 - ロジックの誤り・エッジケースの見落とし
                 - セキュリティ上の懸念（入力値検証・権限チェック等）
                 - パフォーマンス上の懸念
                 - 既存スタイルとの整合性

            3. **policy 適合チェック**
               - `policy.yml` を読み、変更が `allowed_dirs` / `hard_gate` の範囲内か確認する

            4. **PR 本文チェック**
               - 目的・変更点・影響範囲・リスク・ロールバック手順が記載されているか確認する

            ### 指摘の分類
            - 🔴 重大: マージ前に必ず対応が必要
            - 🟡 要確認: 意図を確認したい点
            - 🟢 提案: 対応任意の改善案

            ### 出力先
            この PR（#${{ github.event.issue.number }}）にコメントとして投稿する。
            コメントの冒頭に `## 👀 Review: PR #${{ github.event.issue.number }}` と記載する。
            末尾に必ず「マージ判断は人間が行ってください。」と記載する。

            ## PR 本文
            ${{ github.event.issue.body }}
          allowed_tools: "Read,Glob,Grep"
