name: ai-review

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write

jobs:
  ai-review:
    if: >-
      github.event.issue.pull_request != null &&
      contains(fromJSON('["OWNER","MEMBER","COLLABORATOR"]'), github.event.comment.author_association) &&
      startsWith(github.event.comment.body, '/run-claude review')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Claude review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ github.token }}
          max_tokens: 8000
          direct_prompt: |
            PR #${{ github.event.issue.number }} ã®ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚

            ## ã‚ãªãŸã®å½¹å‰²
            reviewer Subagent ã§ã™ã€‚PR ã®å·®åˆ†ã‚’ read-only ã§ç¢ºèªã—ã€å“è³ªä¸Šã®æ‡¸å¿µã‚’æŒ‡æ‘˜ãƒ»è³ªå•ã—ã¦ãã ã•ã„ã€‚
            **ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ãªã„ã§ãã ã•ã„ã€‚ãƒãƒ¼ã‚¸ã®å¯å¦ã‚’æ–­è¨€ã—ãªã„ã§ãã ã•ã„ã€‚**

            ### ç¢ºèªäº‹é …

            1. **AC â†’ Test æ•´åˆ**
               - PR æœ¬æ–‡ã®ã€ŒAC â†’ Test å¯¾å¿œè¡¨ã€ã‚’èª­ã‚€
               - å„ACãŒãƒ†ã‚¹ãƒˆã§æ‹…ä¿ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹
               - æœªã‚«ãƒãƒ¼ã® AC ã‚’æŒ‡æ‘˜ã™ã‚‹

            2. **å®Ÿè£…ã®è¦³ç‚¹ãƒã‚§ãƒƒã‚¯**
               - å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ Read ã§èª­ã¿ã€ä»¥ä¸‹ã‚’ç¢ºèªã™ã‚‹
                 - ãƒ­ã‚¸ãƒƒã‚¯ã®èª¤ã‚Šãƒ»ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã®è¦‹è½ã¨ã—
                 - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®æ‡¸å¿µï¼ˆå…¥åŠ›å€¤æ¤œè¨¼ãƒ»æ¨©é™ãƒã‚§ãƒƒã‚¯ç­‰ï¼‰
                 - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä¸Šã®æ‡¸å¿µ
                 - æ—¢å­˜ã‚¹ã‚¿ã‚¤ãƒ«ã¨ã®æ•´åˆæ€§

            3. **policy é©åˆãƒã‚§ãƒƒã‚¯**
               - `policy.yml` ã‚’èª­ã¿ã€å¤‰æ›´ãŒ `allowed_dirs` / `hard_gate` ã®ç¯„å›²å†…ã‹ç¢ºèªã™ã‚‹

            4. **PR æœ¬æ–‡ãƒã‚§ãƒƒã‚¯**
               - ç›®çš„ãƒ»å¤‰æ›´ç‚¹ãƒ»å½±éŸ¿ç¯„å›²ãƒ»ãƒªã‚¹ã‚¯ãƒ»ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹

            ### æŒ‡æ‘˜ã®åˆ†é¡
            - ğŸ”´ é‡å¤§: ãƒãƒ¼ã‚¸å‰ã«å¿…ãšå¯¾å¿œãŒå¿…è¦
            - ğŸŸ¡ è¦ç¢ºèª: æ„å›³ã‚’ç¢ºèªã—ãŸã„ç‚¹
            - ğŸŸ¢ ææ¡ˆ: å¯¾å¿œä»»æ„ã®æ”¹å–„æ¡ˆ

            ### å‡ºåŠ›å…ˆ
            ã“ã® PRï¼ˆ#${{ github.event.issue.number }}ï¼‰ã«ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æŠ•ç¨¿ã™ã‚‹ã€‚
            ã‚³ãƒ¡ãƒ³ãƒˆã®å†’é ­ã« `## ğŸ‘€ Review: PR #${{ github.event.issue.number }}` ã¨è¨˜è¼‰ã™ã‚‹ã€‚
            æœ«å°¾ã«å¿…ãšã€Œãƒãƒ¼ã‚¸åˆ¤æ–­ã¯äººé–“ãŒè¡Œã£ã¦ãã ã•ã„ã€‚ã€ã¨è¨˜è¼‰ã™ã‚‹ã€‚

            ## PR æœ¬æ–‡
            ${{ github.event.issue.body }}
          allowed_tools: "Read,Glob,Grep"
