name: ai-implement

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: run-claude-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  ai-implement:
    if: >-
      github.event.issue.pull_request == null &&
      startsWith(github.event.comment.body, '/run-claude implement')
    runs-on: ubuntu-latest
    steps:
      - name: Validate labels
        id: guard
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;

            const labels = (context.payload.issue.labels || []).map(l => l.name);
            const hasAiReady = labels.includes("ai-ready");
            const blocked = labels.includes("ai-question") || labels.includes("ai-blocked");

            if (!hasAiReady || blocked) {
              const reasons = [];
              if (!hasAiReady) reasons.push("- `ai-ready` ãƒ©ãƒ™ãƒ«ãŒæœªä»˜ä¸ã§ã™");
              if (blocked) reasons.push("- `ai-question` ã¾ãŸã¯ `ai-blocked` ãƒ©ãƒ™ãƒ«ãŒä»˜ä¸ã•ã‚Œã¦ã„ã¾ã™");

              const body = [
                "`/run-claude implement` ã¯ç¾åœ¨å®Ÿè¡Œã§ãã¾ã›ã‚“ã€‚",
                "",
                "ç†ç”±:",
                ...reasons,
                "",
                "å¯¾å¿œå¾Œã«ã‚‚ã†ä¸€åº¦ `/run-claude implement` ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ãã ã•ã„ã€‚",
              ].join("\n");

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body,
              });
              core.setFailed("ai-implement preconditions are not satisfied");
            }

      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Claude implement
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ github.token }}
          max_tokens: 24000
          direct_prompt: |
            Issue #${{ github.event.issue.number }} ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚

            ## ã‚ãªãŸã®å½¹å‰²
            å®Ÿè£…è€…ã§ã™ã€‚ä»¥ä¸‹ã®æ‰‹é †ã§é€²ã‚ã¦ãã ã•ã„ã€‚

            ### Step 1: test-designerï¼ˆãƒ†ã‚¹ãƒˆè¨­è¨ˆï¼‰
            - Issue ã®ã€Œâœ… å—ã‘å…¥ã‚Œæ¡ä»¶ï¼ˆACï¼‰ã€ã¨ã€ŒğŸ§ª ãƒ†ã‚¹ãƒˆè¦³ç‚¹ã€ã‚’èª­ã‚€
            - å„ACã«å¯¾ã—ã¦ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’è¨­è¨ˆã™ã‚‹ï¼ˆAC â†’ Test å¯¾å¿œè¡¨ã‚’ä½œæˆï¼‰
            - ãƒ†ã‚¹ãƒˆãŒæ›¸ã‘ãªã„å ´åˆï¼ˆA/B/Cåˆ¤å®šï¼‰ã‚’ç‰¹å®šã™ã‚‹
              - Cåˆ¤å®šï¼ˆä»•æ§˜ä¸æ˜ï¼‰ãŒã‚ã‚Œã° **æ¨æ¸¬ã›ãš** è³ªå•ãƒªã‚¹ãƒˆã‚’æç¤ºã—ã¦åœæ­¢ã™ã‚‹
              - Båˆ¤å®šãŒã‚ã‚Œã° `ai-blocked` ã‚’æ¨å¥¨ã—ã¦åœæ­¢ã™ã‚‹
            - ãƒ†ã‚¹ãƒˆã‚’å…ˆã«æ›¸ãï¼ˆTest-Firstï¼‰

            ### Step 2: å®Ÿè£…
            - `policy.yml` ã‚’èª­ã¿ã€`allowed_dirs` / `hard_gate` ã‚’ç¢ºèªã™ã‚‹
            - ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆã™ã‚‹: `ai/issue-${{ github.event.issue.number }}-<issue-ã‚¿ã‚¤ãƒˆãƒ«ã®ã‚¹ãƒ©ãƒƒã‚°>`
            - å¤‰æ›´ã¯ `allowed_dirs` ã®ç¯„å›²å†…ã«åã‚ã‚‹
            - `hard_gate` ã®ãƒ‘ã‚¹ã«ã¯çµ¶å¯¾ã«è§¦ã‚Œãªã„
            - `soft_gate` ã®ãƒ‘ã‚¹ã«è§¦ã‚Œã‚‹å ´åˆã¯å¯¾å¿œãƒ©ãƒ™ãƒ«ï¼ˆ`allow-deps` / `allow-config`ï¼‰ãŒãªã‘ã‚Œã°åœæ­¢ã™ã‚‹

            ### Step 3: CI å®Ÿè¡Œ
            - `tools/ci.sh` ã‚’å®Ÿè¡Œã—ã¦ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹
            - ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ãŸå ´åˆã¯æœ€å¤§2ãƒ©ã‚¦ãƒ³ãƒ‰è‡ªå‹•ä¿®æ­£ã‚’è©¦ã¿ã‚‹
            - ä¿®æ­£ã§ããªã„å ´åˆã¯ draft PR ã‚’ä½œæˆã—ã¦åœæ­¢ã™ã‚‹

            ### Step 4: draft PR ä½œæˆ
            - ãƒ–ãƒ©ãƒ³ãƒã‚’ push ã™ã‚‹
            - PR ã‚’ draft ã§ä½œæˆã™ã‚‹
            - PR ã‚¿ã‚¤ãƒˆãƒ«: `[AI] <Issue ã‚¿ã‚¤ãƒˆãƒ«>`
            - PR æœ¬æ–‡ã«ã¯ä»¥ä¸‹ã‚’å«ã‚ã‚‹:
              - ç›®çš„ï¼ˆIssueç•ªå·ã¸ã®ãƒªãƒ³ã‚¯ï¼‰
              - å¤‰æ›´ç‚¹ãƒªã‚¹ãƒˆ
              - AC â†’ Test å¯¾å¿œè¡¨
              - å½±éŸ¿ç¯„å›²
              - ãƒªã‚¹ã‚¯ã¨ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †
              - å®Ÿè¡Œãƒ­ã‚°ï¼ˆRun ID: ${{ github.run_id }}ï¼‰
            - Issue ã« `draft-pr` ãƒ©ãƒ™ãƒ«ã‚’ä»˜ä¸ã™ã‚‹

            ## åœæ­¢æ¡ä»¶ï¼ˆdraft PR ã§ç•™ã‚ã‚‹ï¼‰
            - CI ãŒå¤±æ•—ã—è‡ªå‹•ä¿®æ­£ã§ããªã„å ´åˆ
            - ãƒ†ã‚¹ãƒˆè¨­è¨ˆã§ C/B åˆ¤å®šã® AC ãŒå­˜åœ¨ã™ã‚‹å ´åˆ
            - Policy gate é•åã®å¤‰æ›´ãŒå¿…è¦ãªå ´åˆ

            ## ç¦æ­¢äº‹é …
            - `hard_gate` ã«æŠµè§¦ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®å¤‰æ›´
            - ä¾‹å¤–ãƒ©ãƒ™ãƒ«ãªã—ã§ã® `soft_gate` å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®å¤‰æ›´
            - ãƒ©ãƒ™ãƒ«ãªã—ã®ãƒãƒ¼ã‚¸ï¼ˆdraft çŠ¶æ…‹ã‚’ç¶­æŒã™ã‚‹ã“ã¨ï¼‰

            ## Issueæœ¬æ–‡
            ${{ github.event.issue.body }}
          allowed_tools: "Read,Glob,Grep,Write,Edit,Bash"
