name: slash-commands

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # /stop: ai-blocked ãƒ©ãƒ™ãƒ«ã‚’ä»˜ä¸ã—ã¦åœæ­¢ã‚’å®£è¨€
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  stop:
    if: >-
      contains(fromJSON('["OWNER","MEMBER","COLLABORATOR"]'), github.event.comment.author_association) &&
      startsWith(github.event.comment.body, '/stop')
    runs-on: ubuntu-latest
    steps:
      - name: Add ai-blocked label and post comment
        id: stop_guard
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;

            // ai-blocked ãƒ©ãƒ™ãƒ«ã‚’ä»˜ä¸
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number,
              labels: ["ai-blocked"],
            });

            // ai-ready ãƒ©ãƒ™ãƒ«ã‚’å¤–ã™ï¼ˆæ¬¡å›ã‚³ãƒãƒ³ãƒ‰ã®èª¤çˆ†é˜²æ­¢ï¼‰
            try {
              await github.rest.issues.removeLabel({
                owner,
                repo,
                issue_number,
                name: "ai-ready",
              });
            } catch (_) {
              // ãƒ©ãƒ™ãƒ«ãŒä»˜ã„ã¦ã„ãªã„å ´åˆã¯ç„¡è¦–
            }

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number,
              body: [
                "ğŸ›‘ `/stop` ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚",
                "",
                "- `ai-blocked` ãƒ©ãƒ™ãƒ«ã‚’ä»˜ä¸ã—ã¾ã—ãŸ",
                "- `ai-ready` ãƒ©ãƒ™ãƒ«ã‚’å¤–ã—ã¾ã—ãŸ",
                "",
                "æ¬¡å›ã® AI å®Ÿè¡Œã¯ `ai-blocked` ã‚’å¤–ã—ã€`ai-ready` ã‚’ä»˜ä¸ã—ã¦ã‹ã‚‰å†åº¦ã‚³ãƒãƒ³ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚",
              ].join("\n"),
            });

            core.setOutput("notify", "true");

      - name: Notify external hook (ai-blocked)
        if: steps.stop_guard.outputs.notify == 'true' && secrets.AI_NOTIFY_WEBHOOK_URL != ''
        continue-on-error: true
        env:
          WEBHOOK_URL: ${{ secrets.AI_NOTIFY_WEBHOOK_URL }}
        run: |
          curl -fsS -X POST \
            -H "Content-Type: application/json" \
            -d "{\"event\":\"ai_state_changed\",\"label\":\"ai-blocked\",\"source\":\"slash-commands-stop\",\"repository\":\"${{ github.repository }}\",\"issue_number\":${{ github.event.issue.number }},\"issue_url\":\"${{ github.event.issue.html_url }}\"}" \
            "$WEBHOOK_URL"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # /retry: ç›´å‰ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å†å®Ÿè¡Œ
  #   draft-pr ãƒ©ãƒ™ãƒ«ã‚ã‚Š â†’ implement ã‚’è‡ªå‹•å†å®Ÿè¡Œ
  #   draft-pr ãƒ©ãƒ™ãƒ«ãªã— â†’ plan ã‚’è‡ªå‹•å†å®Ÿè¡Œ
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  retry:
    if: >-
      github.event.issue.pull_request == null &&
      contains(fromJSON('["OWNER","MEMBER","COLLABORATOR"]'), github.event.comment.author_association) &&
      startsWith(github.event.comment.body, '/retry')
    runs-on: ubuntu-latest
    steps:
      - name: Check labels and trigger retry command
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;

            const labels = (context.payload.issue.labels || []).map(l => l.name);
            const hasDraftPr = labels.includes("draft-pr");
            const blocked = labels.includes("ai-question") || labels.includes("ai-blocked");

            if (blocked) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body: [
                  "âš ï¸ `/retry` ã¯ãƒ–ãƒ­ãƒƒã‚¯ä¸­ã®ãŸã‚å®Ÿè¡Œã§ãã¾ã›ã‚“ã€‚",
                  "",
                  "- `ai-question` ã¾ãŸã¯ `ai-blocked` ãƒ©ãƒ™ãƒ«ãŒä»˜ã„ã¦ã„ã¾ã™",
                  "",
                  "å¯¾å¿œå¾Œã«ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚",
                ].join("\n"),
              });
              core.setFailed("retry blocked by ai-question/ai-blocked");
              return;
            }

            const nextCommand = hasDraftPr ? "/run-claude implement" : "/run-claude plan";
            const stage = hasDraftPr ? "implement" : "plan";

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number,
              body: [
                `ğŸ”„ \`/retry\` ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚`,
                "",
                `ç›´å‰ã®ã‚¹ãƒ†ãƒ¼ã‚¸ï¼ˆ**${stage}**ï¼‰ã‚’è‡ªå‹•å†å®Ÿè¡Œã—ã¾ã™ã€‚`,
                "",
                nextCommand,
              ].join("\n"),
            });

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # /rebase: Issue ã«ç´ã¥ã draft PR ã®ãƒ–ãƒ©ãƒ³ãƒã‚’
  #          ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ–ãƒ©ãƒ³ãƒã§æœ€æ–°åŒ–ï¼ˆupdate-branchï¼‰
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  rebase:
    if: >-
      github.event.issue.pull_request == null &&
      contains(fromJSON('["OWNER","MEMBER","COLLABORATOR"]'), github.event.comment.author_association) &&
      startsWith(github.event.comment.body, '/rebase')
    runs-on: ubuntu-latest
    steps:
      - name: Find associated PR and update branch
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;

            // Issue ã«ç´ã¥ã open ãª PR ã‚’æ¢ã™
            const { data: prs } = await github.rest.pulls.list({
              owner,
              repo,
              state: "open",
            });

            // ãƒ–ãƒ©ãƒ³ãƒåã« issue ç•ªå·ãŒå«ã¾ã‚Œã‚‹ã‚‚ã®ã‚’æ¢ã™
            const pattern = `ai/issue-${issue_number}-`;
            const pr = prs.find(p => p.head.ref.startsWith(pattern));

            if (!pr) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body: [
                  "âš ï¸ `/rebase` ã®å¯¾è±¡ã¨ãªã‚‹ PR ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚",
                  "",
                  `- ãƒ–ãƒ©ãƒ³ãƒåãŒ \`ai/issue-${issue_number}-*\` ã«ä¸€è‡´ã™ã‚‹ open PR ãŒã‚ã‚Šã¾ã›ã‚“`,
                  "",
                  "`/run-claude implement` ã§ draft PR ã‚’ä½œæˆã—ã¦ã‹ã‚‰ `/rebase` ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚",
                ].join("\n"),
              });
              core.setFailed("no PR found for rebase");
              return;
            }

            // GitHub ã® update-branch API ã§ãƒ–ãƒ©ãƒ³ãƒã‚’æœ€æ–°åŒ–
            try {
              await github.rest.pulls.updateBranch({
                owner,
                repo,
                pull_number: pr.number,
              });

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body: [
                  `âœ… \`/rebase\` å®Œäº†: PR #${pr.number} ã®ãƒ–ãƒ©ãƒ³ãƒã‚’æœ€æ–°åŒ–ã—ã¾ã—ãŸã€‚`,
                  "",
                  `- ãƒ–ãƒ©ãƒ³ãƒ: \`${pr.head.ref}\``,
                  `- PR: ${pr.html_url}`,
                ].join("\n"),
              });
            } catch (err) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body: [
                  `âŒ \`/rebase\` å¤±æ•—: PR #${pr.number} ã®ãƒ–ãƒ©ãƒ³ãƒæ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`,
                  "",
                  `\`\`\``,
                  String(err.message),
                  `\`\`\``,
                  "",
                  "ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãŒã‚ã‚‹å ´åˆã¯æ‰‹å‹•ã§è§£æ¶ˆã—ã¦ãã ã•ã„ã€‚",
                ].join("\n"),
              });
              core.setFailed(`rebase failed: ${err.message}`);
            }
